---
layout: post
category: Publish
title: 一种Android多语言资源文件的集成方案
tagline:
tag: [Android系统原理]
---

# 1. 背景

Android的资源管理方式，使得应用程序能够方便地完成多语言适配。应用程序只需要关心资源名称是什么，譬如，应用程序在使用字符串资源时，只需要使用 **R.string.app_name**，在不同的语言环境下，这个字符可以显示出不同的内容。应用程序需要做的，就是按照Android的命名规范，把多语言的资源文件放在特定的目录下，Android系统层会完成资源名称到实际资源的映射。

对于整个Android系统而言，包括数十个应用程序，还有框架层的公共资源，多语言适配就上升到了系统层面的问题：**如何统筹各个模块的多语言资源适配？**

**首先**，这是一个业务相关的话题，在做Android系统开发时，一般都会以Android模块为单位，划分为不同业务组进行协同开发，通常，框架层是一个业务组，电话、短信等是一个业务组，视频，音乐又是另外的业务组，不同业务组是分开横向管理的，各自对自身业务负责。当涉及到多语言翻译时，又会有一个新的业务组，纵深到已有的各个业务组，专门处理其多语言资源的翻译。这就形成了一个横纵相连的组织结构，多语言翻译都是交由第三方专业机构完成，这个纵向的多语言业务组的职责就是按照Android的规范来统筹集成翻译资源。

**然后**，我们来探讨一下技术相关的话题，多语言资源需要合入已有模块的代码库，并且多语言资源也需要及时地跟进代码的变化，譬如，已有模块新增了字符串，那么，这些字符串的翻译也需要尽快的完成。当已有模块达到发布状态，通常会拉出发布分支(Release分支)，意味着该模块已经完成了拟定的需求，并且已经适配了多语言。这时候如果发现存在翻译错误，则需要在发布分支上进行修复。

Android系统开发要兼顾众多模块，要做到多个模块的统一，一个常见的技术方案是：约定一个统一的时间拉取发布分支，所有模块都要求在这个约定时间之前完成计划任务。这个约定的时间就是一只“隐形的手”，把各模块捏合到一起。多语言翻译只需要在此时间之前集成翻译资源即可，当出现严重问题时，再到发布分支上进行修复。然而，这种方案要求所有模块能够掐准发布时间，一定程度上限制了模块自主开发的灵活性。譬如，桌面程序(Launcher)是一个Android系统应用程序，在该种设计方案下，它必须配合整个系统的发布时间。实际上，有另外的技术方案可以让桌面程序做到更加灵活，按照自己的节奏进行发布。

展开讨论之前，我们来看整个Android系统的编译过程：先找到所有待编译模块的依赖关系，然后按序编译出各个子模块，最后将编译产物打包成刷机文件，通常我们称最后可以刷入手机的文件为固件。上文提到约定发布时间的方案，就相当于告诉所有模块：“我要在这个时间发起编译，你们都必须准备好，不能出岔子”；但凡有一个模块有出现严重缺陷，甚至编译错误，那悲剧了，所有模块都会受到牵连。所以这种严格的发布时间限制，无形中造成所有模块的压力。实际的Android系统研发中，由于多人协同开发，低级的编译出错问题其实都很常见，整个Android固件难产其实是行业的共性问题。

我们可以想这么一个问题：既然整个Android固件是由众多模块打包而成，那么，以二进制的形式将子模块的编译产物预装(PREBUILT)到固件，不就能减少很多子模块的编译问题吗？这样一来，各个子模块的编译就从整个系统的编译中抽离出来，而且不需要严格遵循统一的发布时间，因为整个固件只需要打包各个模块的编译产物，各模块的编译时控制在自己手上的。一些Android系统研发厂商确实使用了这种方案，很多系统应用，诸如桌面、电话、短彩信、视频等，都以一个APK的形式预装到固件中。这些系统应用可以做到独立发布，达到的效果是：Android固件的版本没有更新，而这些应用可以自己推送新版本，就像一个从第三方应用市场下载的普通应用程序一样。虽然，这种方案使得部分模块的在业务上变得更加灵活，但多语言翻译的却变得很难集成。由于不同的模块按照自己的业务需求进行版本控制，不能再要求所有的模块基于一个约定的时间发起编译，作为多语言资源集成的业务组，需要知道所有模块的发布进度，然而，在实际操作过程中，这需要耗费巨大的沟通成本，远没有约定统一的发布时间来得简单高效。

**最后**，本文提出一种方案，适用于Android系统开发时，各业务模块横纵协作的场景，既能保障多模块自主开发的灵活性，又能保障多语言翻译的集成效率。

# 2. Android编译资源的Overlay机制

Android应用程序都会经历资源编译这一过程，将原始的资源文件，编译成二进制文件。资源文件的编译器是AAPT(Android Asset Packaging Tool)